<!DOCTYPE html>
<html>
<head>
    <title>Discord Mobile Client</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin:0; padding:0; font-family:sans-serif; background:#181818; color:#eee; overflow:hidden; }
        #container { display:flex; height:100vh; width:100vw; }

        /* Servers Panel */
        #servers { width:50px; background:#202020; overflow-y:auto; display:flex; flex-direction:column; align-items:center; border-right:1px solid #444; scrollbar-width:none; -ms-overflow-style:none; }
        #servers::-webkit-scrollbar { display:none; }
        .server-avatar { width:40px; height:40px; border-radius:50%; margin:5px 0; cursor:pointer; border:2px solid transparent; }
        .server-avatar.selected { border:2px solid #7289da; }

        /* Channels / DM List */
        #channels { width:120px; background:#2c2c2c; overflow-y:auto; border-right:1px solid #444; scrollbar-width:none; -ms-overflow-style:none; }
        #channels::-webkit-scrollbar { display:none; }
        button.channel { width:100%; padding:5px; margin:2px 0; background:#333; color:#eee; border:none; border-radius:3px; text-align:left; cursor:pointer; }
        button.channel.selected { background:#444; }

        /* Chat Panel */
        #chat-container { flex:1; display:flex; flex-direction:column; background:#1e1e1e; }
        #messages { flex:1; overflow-y:auto; padding:10px; scrollbar-width:none; -ms-overflow-style:none; }
        #messages::-webkit-scrollbar { display:none; }
        .message { margin:5px 0; padding:5px; background:linear-gradient(145deg,#2e2e2e,#3a3a3a); border-radius:5px; }
        .message img { max-width:150px; max-height:150px; display:block; margin-top:5px; border-radius:3px; }
        .message b { cursor:pointer; color:#ffd700; }

        /* Message Input */
        #msgInputContainer { display:flex; padding:5px; border-top:1px solid #444; }
        #msgInput { flex:1; padding:5px; border-radius:3px; border:1px solid #555; background:#2c2c2c; color:#eee; font-size:14px; }
        #msgFile { margin-left:5px; }
        #msgSend { margin-left:5px; padding:5px 10px; border:none; border-radius:3px; background:#7289da; color:#fff; cursor:pointer; }

        /* Profile Preview */
        #profilePreview { position:absolute; background:#2a2a2a; border:1px solid #555; border-radius:5px; padding:5px; display:none; z-index:1000; }

        /* Settings Panel */
        #settingsPanel { position:absolute; top:50px; left:50%; transform:translateX(-50%); background:#2a2a2a; border:1px solid #555; border-radius:5px; padding:10px; display:none; width:250px; z-index:1000; }
        #settingsPanel button { display:block; width:100%; margin:5px 0; padding:5px; border:none; border-radius:3px; background:#444; color:#eee; cursor:pointer; }
    </style>
</head>
<body>
<div id="container">
    <div id="servers">
        <img src="logo.png" id="logoBtn" style="width:40px;height:40px;margin:5px;cursor:pointer;">
    </div>
    <div id="channels"></div>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="msgInputContainer">
            <input type="text" id="msgInput" placeholder="Write a message">
            <input type="file" id="msgFile">
            <button id="msgSend">Send</button>
        </div>
    </div>
</div>

<div id="profilePreview"></div>

<div id="settingsPanel">
    <button id="closeSettings">Close Settings</button>
    <button id="logoutBtn">Logout</button>
    <button id="toggleDMsBtn">Switch to DMs</button>
    <button id="dummySetting1">Setting 1</button>
    <button id="dummySetting2">Setting 2</button>
</div>

<script>
var token = localStorage.getItem("botToken");
if(!token) window.location.href="login.html";

var selectedGuild = null;
var selectedChannel = null;
var selectedDM = null;
var guildChannels = {};
var currentMode = "guild"; // "guild" = server, "dm" = DMs
var previewDiv = document.getElementById("profilePreview");
var settingsPanel = document.getElementById("settingsPanel");

// --------------------- PROXY FETCH ---------------------
function proxyFetch(path, method, body, callback, isForm=false){
    var xhr = new XMLHttpRequest();
    xhr.open(method, "/proxy/"+path, true);
    xhr.setRequestHeader("Authorization", token);
    if(!isForm) xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = function(){
        if(xhr.readyState===4){
            try { callback(JSON.parse(xhr.responseText)); }
            catch(e){ callback(xhr.responseText); }
        }
    };
    xhr.send(body ? (isForm ? body : JSON.stringify(body)) : null);
}

// --------------------- LOAD GUILDS ---------------------
function loadGuilds(){
    proxyFetch("users/@me/guilds","GET",null,function(guilds){
        var html="";
        html+='<img src="logo.png" id="logoBtn" style="width:40px;height:40px;margin:5px;cursor:pointer;">'; // top logo
        for(var i=0;i<guilds.length;i++){
            var g=guilds[i];
            var avatarUrl = g.icon ? "https://cdn.discordapp.com/icons/"+g.id+"/"+g.icon+".png" : "default.png";
            html += '<img class="server-avatar" id="guild_'+g.id+'" src="'+avatarUrl+'" onclick="selectGuild(\''+g.id+'\')">';
        }
        document.getElementById("servers").innerHTML = html;
        document.getElementById("logoBtn").addEventListener("click", toggleDMs);
        if(guilds.length>0) selectGuild(guilds[0].id);
    });
}

// --------------------- GUILD & CHANNELS ---------------------
function selectGuild(guildId){
    selectedGuild = guildId;
    currentMode="guild";
    var avatars = document.getElementsByClassName("server-avatar");
    for(var i=0;i<avatars.length;i++){ avatars[i].className="server-avatar"; }
    document.getElementById("guild_"+guildId).className="server-avatar selected";
    loadChannels(guildId);
}

function loadChannels(guildId){
    proxyFetch("guilds/"+guildId+"/channels","GET",null,function(channels){
        var html="";
        if(channels && channels.length){
            guildChannels[guildId]=channels;
            for(var i=0;i<channels.length;i++){
                var c=channels[i];
                if(c.type===0){
                    html+='<button class="channel" onclick="selectChannel(\''+c.id+'\', this)">'+c.name+'</button>';
                }
            }
        } else html="<i>No access or no channels</i>";
        document.getElementById("channels").innerHTML=html;
        if(channels && channels.length>0) selectChannel(channels[0].id, document.getElementsByClassName("channel")[0]);
    });
}

function selectChannel(channelId, btn){
    selectedChannel = channelId;
    selectedDM = null;
    var buttons = document.getElementsByClassName("channel");
    for(var i=0;i<buttons.length;i++){ buttons[i].className="channel"; }
    if(btn) btn.className="channel selected";
    loadMessages(channelId);
}

// --------------------- LOAD MESSAGES ---------------------
function loadMessages(channelId){
    if(!channelId) return;
    proxyFetch("channels/"+channelId+"/messages?limit=20","GET",null,function(msgs){
        var html="";
        for(var i=msgs.length-1;i>=0;i--){
            var m=msgs[i];
            html+='<div class="message">';
            if(m.author.avatar){
                html+='<img src="https://cdn.discordapp.com/avatars/'+m.author.id+'/'+m.author.avatar+'.png" style="width:30px;height:30px;border-radius:50%;margin-right:5px;vertical-align:middle;">';
            }
            html+='<b onclick="showProfile(\''+m.author.id+'\', event)">'+m.author.username+'</b>: '+m.content+'<br>';
            if(m.attachments && m.attachments.length){
                for(var j=0;j<m.attachments.length;j++){
                    html+='<img src="'+m.attachments[j].url+'">';
                }
            }
            html+='</div>';
        }
        var msgDiv=document.getElementById("messages");
        msgDiv.innerHTML=html;
        msgDiv.scrollTop=msgDiv.scrollHeight;
    });
}

// --------------------- SEND MESSAGE ---------------------
function sendMessage(){
    if(currentMode==="guild" && !selectedChannel) return alert("Select a channel first");
    if(currentMode==="dm" && !selectedDM) return alert("Select a DM first");
    var content = document.getElementById("msgInput").value;
    var fileInput = document.getElementById("msgFile");
    var targetId = currentMode==="guild" ? selectedChannel : selectedDM;

    if(fileInput.files.length>0){
        var form = new FormData();
        form.append("file", fileInput.files[0]);
        if(content) form.append("content", content);
        proxyFetch("channels/"+targetId+"/messages","POST",form,true,function(){ fileInput.value=""; loadMessages(targetId); });
        document.getElementById("msgInput").value="";
    } else if(content){
        proxyFetch("channels/"+targetId+"/messages","POST",{content:content},function(){
            document.getElementById("msgInput").value="";
            loadMessages(targetId);
        });
    }
}

document.getElementById("msgSend").addEventListener("click", sendMessage);
document.getElementById("msgInput").addEventListener("keypress", function(e){ if(e.keyCode===13) sendMessage(); });

// --------------------- PROFILE PREVIEW ---------------------
function showProfile(userId, event){
    proxyFetch("users/"+userId,"GET",null,function(user){
        previewDiv.style.display="block";
        previewDiv.style.left=(event.clientX+10)+"px";
        previewDiv.style.top=(event.clientY+10)+"px";
        previewDiv.innerHTML = "<b>"+user.username+"#"+user.discriminator+"</b><br>"+
            "<img src='https://cdn.discordapp.com/avatars/"+user.id+"/"+user.avatar+".png' style='width:80px;height:80px;'><br>ID: "+user.id;
    });
}
document.addEventListener("click", function(e){ if(!e.target.closest(".message b")) previewDiv.style.display="none"; });

// --------------------- DM / GROUP CHAT ---------------------
function toggleDMs(){
    if(currentMode==="guild"){
        currentMode="dm";
        loadDMs();
    } else if(selectedGuild){
        currentMode="guild";
        loadChannels(selectedGuild);
    }
}

function loadDMs(){
    proxyFetch("users/@me/channels","GET",null,function(channels){
        var html="";
        for(var i=0;i<channels.length;i++){
            var c = channels[i];
            var name = "";
            if(c.type===1){ name = c.recipients[0].username; }
            else if(c.type===3){ name = c.name || "Group Chat"; }
            else continue;
            html+='<button class="channel" onclick="selectDM(\''+c.id+'\', this)">'+name+'</button>';
        }
        document.getElementById("channels").innerHTML = html;
    });
}

function selectDM(dmId, btn){
    selectedDM = dmId;
    selectedChannel = null;
    var buttons = document.getElementsByClassName("channel");
    for(var i=0;i<buttons.length;i++){ buttons[i].className="channel"; }
    if(btn) btn.className="channel selected";
    loadMessages(dmId);
}

// --------------------- SETTINGS ---------------------
document.getElementById("closeSettings").addEventListener("click", function(){ settingsPanel.style.display="none"; });
document.getElementById("logoutBtn").addEventListener("click", function(){ localStorage.removeItem("botToken"); window.location.href="login.html"; });

// Open settings with right-click on logo
document.getElementById("logoBtn").addEventListener("contextmenu", function(e){
    e.preventDefault();
    settingsPanel.style.display="block";
});

// --------------------- REFRESH MESSAGES ---------------------
setInterval(function(){ 
    if(currentMode==="guild" && selectedChannel) loadMessages(selectedChannel); 
    if(currentMode==="dm" && selectedDM) loadMessages(selectedDM);
},5000);

loadGuilds();
</script>
</body>
</html>
